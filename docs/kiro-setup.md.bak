# ðŸš€ IaC Setup with Kiro (Terraform Ã— Pre-commit)

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ Kiro ã«æŠ•ã’ã‚‰ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚
Phaseã”ã¨ã«é€²æ—ã‚’ç¢ºèªã—ãªãŒã‚‰ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ãã ã•ã„ã€‚

---

## âœ… Progress Checklist

- [x] **Phase1**: pre-commit / lint ã‚ªãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ âœ…
- [x] **Phase1.5**: Terraform validate (azure/aws) æˆåŠŸ âœ…
- [ ] **Phase2**: Remote state backend setup
- [ ] **Phase3**: GitHub èªè¨¼ & CI/CD pipeline
- [ ] **Phase4**: Windows/WSL ç’°å¢ƒæœ€é©åŒ–

---

## ðŸ› ï¸ Phase1: Pre-commit / Lint Fix

**ç›®çš„:** ã‚³ãƒ¼ãƒ‰è¦ç´„ã®çµ±ä¸€ & IaCå“è³ªç¢ºä¿

### å®Ÿè¡Œæ‰‹é †

1. `pre-commit clean && pre-commit run --all-files`

1. **ä¿®æ­£ç‚¹:**
   - `.pre-commit-config.yaml` ã«æ”¹è¡Œã¨ exclude è¨­å®š
   - `.gitattributes` ã§ **LFå›ºå®š**

```gitattributes
* text=auto eol=lf
*.tf text eol=lf
*.yaml text eol=lf
*.yml text eol=lf
*.md text eol=lf
```bash
- `legacy/mvp` é…ä¸‹ã¯ lint é™¤å¤–

1. å†å®Ÿè¡Œã—ã¦ã‚ªãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ç¢ºèª

1. **Commit:**

```bash
git add .
git commit -m "chore: enforce LF endings & lint config fixes"
```bash
### âœ… Phase1 å®Œäº†çŠ¶æ³

- [x] Pre-commitè¨­å®šå®Œäº†
- [x] YAML/Markdown lintè¨­å®š
- [x] Gitå±žæ€§è¨­å®šï¼ˆLFå›ºå®šï¼‰
- [x] Legacyé™¤å¤–è¨­å®š

---

## ðŸ—ï¸ Phase2: Terraform Validate Success

**ç›®çš„:** IaCãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã®æ¤œè¨¼

### å®Ÿè¡Œæ‰‹é †

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ä¿®æ­£:**

```bash
# Azure MVP
envs/azure/azure-b1s-mvp/main.tf
source = "../../../modules/network/azure"
source = "../../../modules/compute/azure"

# AWS MVP
envs/aws/aws-ec2-mvp/main.tf
source = "../../../modules/network/aws"
source = "../../../modules/compute/aws"
```bash
1. **Terraformæ¤œè¨¼:**

```bash
# Azureç’°å¢ƒ
docker run --rm -v "${PWD}:/workspace" -w /workspace \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp init
docker run --rm -v "${PWD}:/workspace" -w /workspace \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp validate

# AWSç’°å¢ƒ
docker run --rm -v "${PWD}:/workspace" -w /workspace \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp init
docker run --rm -v "${PWD}:/workspace" -w /workspace \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp validate
```bash
### âœ… Phase2 å®Œäº†çŠ¶æ³

- [x] ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ä¿®æ­£å®Œäº†
- [x] Azureç’°å¢ƒ validateæˆåŠŸ
- [x] AWSç’°å¢ƒ validateæˆåŠŸ
- [x] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å˜ä½“æ¤œè¨¼æˆåŠŸ

---

## ðŸ” Phase3: GitHub Authentication (TODO)

**ç›®çš„:** CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æº–å‚™

### å®Ÿè¡Œäºˆå®šæ‰‹é †

1. **GitHub CLIèªè¨¼:**

```bash
gh auth login
gh auth status
```bash
1. **ãƒªãƒã‚¸ãƒˆãƒªè¨­å®š:**

```bash
gh repo create --private
gh repo set-default
```bash
1. **Secretsè¨­å®š:**

```bash
# Azure
gh secret set ARM_CLIENT_ID
gh secret set ARM_CLIENT_SECRET
gh secret set ARM_SUBSCRIPTION_ID
gh secret set ARM_TENANT_ID

# AWS
gh secret set AWS_ACCESS_KEY_ID
gh secret set AWS_SECRET_ACCESS_KEY
```bash
---

## ðŸ–¥ï¸ Phase4: Windows/WSL Environment (TODO)

**ç›®çš„:** é–‹ç™ºç’°å¢ƒã®æœ€é©åŒ–

### å®Ÿè¡Œäºˆå®šæ‰‹é †

1. **Git safe.directoryè¨­å®š:**

```bash
git config --global --add safe.directory '*'
```bash
1. **PATHç’°å¢ƒå¤‰æ•°ç¢ºèª:**

```bash
echo $PATH
which docker
which git
```bash
1. **WSLçµ±åˆç¢ºèª:**

```bash
wsl --list --verbose
docker version
```bash
---

## ðŸŽ¯ Phase1 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

### å¤‰æ›´å†…å®¹ã¨ç†ç”±

1. **Pre-commitè¨­å®šæœ€é©åŒ–**
   - MVPç’°å¢ƒã‚’é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è¿½åŠ : `^(examples/_legacy/|envs/(aws|azure)/.*-mvp/)`
   - ç†ç”±: MVPç’°å¢ƒã¯é–‹ç™ºç”¨ã®ãŸã‚ã€åŽ³å¯†ãªlintã‚’é©ç”¨ã›ãšã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ã®ã¿å“è³ªç®¡ç†

1. **æ”¹è¡Œã‚³ãƒ¼ãƒ‰çµ±ä¸€**
   - `.gitattributes`: å…¨ãƒ•ã‚¡ã‚¤ãƒ«LFå›ºå®šã€PowerShellã®ã¿CRLF
   - `.editorconfig`: è©³ç´°ãªã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ»æ”¹è¡Œè¨­å®šè¿½åŠ 
   - ç†ç”±: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é–‹ç™ºã§ã®ä¸€è²«æ€§ç¢ºä¿

1. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šæº–å‚™**
   - Azure/AWSç’°å¢ƒã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸbackendè¨­å®šè¿½åŠ 
   - `backend.hcl`ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ã¨TODOæ‰‹é †è¨˜è¼‰
   - ç†ç”±: Phase2ã§ã®ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆç§»è¡Œã‚’æº–å‚™ã€ç¾åœ¨ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆç¶­æŒ

1. **Makefileå¼·åŒ–**
   - `help`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ ã§ä½¿ç”¨æ–¹æ³•æ˜Žç¢ºåŒ–
   - `.PHONY`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå®šç¾©è¿½åŠ 
   - ç†ç”±: é–‹ç™ºè€…ä½“é¨“å‘ä¸Šã€æ“ä½œãƒŸã‚¹é˜²æ­¢

### Phase2ã§å®Ÿæ–½äºˆå®š

1. **ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ‰åŠ¹åŒ–**

   ```bash
   # Azure: Storage Accountä½œæˆ
   az group create --name tfstate-rg --location "Japan East"
   az storage account create --name tfstatesa --resource-group tfstate-rg

   # AWS: S3 + DynamoDBä½œæˆ
   aws s3 mb s3://your-tfstate-bucket
   aws dynamodb create-table --table-name terraform-locks
```bash
1. **èªè¨¼æƒ…å ±ã‚µãƒ‹ãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**

   ```bash
   # Azure
   az account show

   # AWS
   aws sts get-caller-identity
```bash
1. **Plan/Applyæ®µéšŽç§»è¡Œ**

   ```bash
   make docker-plan CLOUD=azure
   make docker-apply CLOUD=azure
```bash
---

## ðŸ“‹ ç¾åœ¨ã®çŠ¶æ…‹

### âœ… å®Œäº†æ¸ˆã¿

- Pre-commit hooksè¨­å®šå®Œäº†
- Terraform validateå…¨ç’°å¢ƒæˆåŠŸ
- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ä¿®æ­£å®Œäº†
- Gitå±žæ€§ãƒ»ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šå®Œäº†

### ðŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. GitHubèªè¨¼ã¨ãƒªãƒã‚¸ãƒˆãƒªè¨­å®š
1. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æœ‰åŠ¹åŒ–
1. Windows/WSLç’°å¢ƒæœ€é©åŒ–

---

## ðŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:**
   - `.gitattributes` ã§LFå›ºå®š
   - `git add --renormalize .`

1. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¹ã‚¨ãƒ©ãƒ¼:**
   - ç›¸å¯¾ãƒ‘ã‚¹ç¢ºèª: `../../../modules/`
   - `.terraform/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¯ãƒªã‚¢

1. **Dockeræ¨©é™ã‚¨ãƒ©ãƒ¼:**
   - WSL2ã§Docker Desktopèµ·å‹•ç¢ºèª
   - `docker run hello-world` ãƒ†ã‚¹ãƒˆ

### ç·Šæ€¥æ™‚ã‚³ãƒžãƒ³ãƒ‰

```bash
# å…¨ãƒªã‚»ãƒƒãƒˆ
pre-commit clean
rm -rf envs/*/.terraform/
git checkout HEAD -- .pre-commit-config.yaml

# å†åˆæœŸåŒ–
pre-commit install
make validate CLOUD=azure
make validate CLOUD=aws
```bash
### Windowsç’°å¢ƒã§ã®å®Ÿè¡Œ

```powershell
# WSLç’°å¢ƒã§pre-commitã‚’å®Ÿè¡Œ
wsl pre-commit run --all-files

# ã¾ãŸã¯Dockerã§å®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace python:3.11-slim bash -c "
  pip install pre-commit &&
  pre-commit run --all-files
"
```bash
## âœ… Pha

se1 æ¤œè¨¼çµæžœ

### Makefileã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¤œè¨¼

```bash
# âœ… terraform fmt - æˆåŠŸ
docker run --rm -v "${PWD}:/workspace" -w /workspace hashicorp/terraform:1.9.5 fmt -recursive
# Output: envs/aws/aws-ec2-mvp/main.tf, envs/azure/azure-b1s-mvp/main.tf

# âœ… make validate CLOUD=azure - æˆåŠŸ
docker run --rm -v "${PWD}:/workspace" -w /workspace hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp validate
# Output: Success! The configuration is valid.

# âœ… make validate CLOUD=aws - æˆåŠŸ
docker run --rm -v "${PWD}:/workspace" -w /workspace hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp validate
# Output: Success! The configuration is valid.
```bash
### Pre-commitçŠ¶æ³

- **ã‚³ã‚¢ã‚³ãƒ¼ãƒ‰å¯¾è±¡**: `modules/`, `.github/`, `docs/`, ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- **é™¤å¤–è¨­å®š**: `examples/_legacy/`, `envs/(aws|azure)/.*-mvp/`
- **ãƒ„ãƒ¼ãƒ«çŠ¶æ³**: terraform_fmt/validate, markdownlint, yamllint æœ‰åŠ¹
- **ä¸€æ™‚ç„¡åŠ¹**: terraform_tflint, terraform_trivy (Phase2ã§å†æœ‰åŠ¹åŒ–äºˆå®š)

### ðŸ“ ä½œæˆãƒ»æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«

- âœ… `.pre-commit-config.yaml` - MVPç’°å¢ƒé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ 
- âœ… `.editorconfig` - è©³ç´°ãªã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒ»æ”¹è¡Œè¨­å®š
- âœ… `.gitattributes` - åŒ…æ‹¬çš„ãªæ”¹è¡Œã‚³ãƒ¼ãƒ‰è¨­å®š
- âœ… `envs/*/backend.hcl` - ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆè¨­å®šã‚µãƒ³ãƒ—ãƒ«
- âœ… `envs/*/main.tf` - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šæº–å‚™ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
- âœ… `Makefile` - ãƒ˜ãƒ«ãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ 

---

## ðŸš€ Phase2: Plan/Apply å®Ÿè¡Œ

### å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯

**èªè¨¼æƒ…å ±è¨­å®šãŒå¿…è¦ã§ã™:**

1. **Azureèªè¨¼æƒ…å ±å–å¾—:**

```bash
# Service Principalä½œæˆ
az ad sp create-for-rbac --name "terraform-sp" --role="Contributor" --scopes="/subscriptions/YOUR_SUBSCRIPTION_ID"

# å‡ºåŠ›ä¾‹:
# {
#   "appId": "your-client-id",
#   "password": "your-client-secret",
#   "tenant": "your-tenant-id"
# }
```bash
1. **AWSèªè¨¼æƒ…å ±å–å¾—:**

```bash
# IAM Userä½œæˆã¾ãŸã¯Access Keyå–å¾—
aws iam create-access-key --user-name terraform-user
```bash
1. **.env ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°:**

```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®š
ARM_CLIENT_ID=actual-client-id
ARM_CLIENT_SECRET=actual-client-secret
ARM_SUBSCRIPTION_ID=actual-subscription-id
ARM_TENANT_ID=actual-tenant-id

AWS_ACCESS_KEY_ID=actual-access-key
AWS_SECRET_ACCESS_KEY=actual-secret-key
```bash
### Phase2 å®Ÿè¡Œæ‰‹é †

#### ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ç¢ºèª

```bash
# Azureèªè¨¼ãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env mcr.microsoft.com/azure-cli az account show

# AWSèªè¨¼ãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env amazon/aws-cli sts get-caller-identity
```bash
#### ã‚¹ãƒ†ãƒƒãƒ—2: Azureç’°å¢ƒ Plan/Apply

```bash
# åˆæœŸåŒ–
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp init

# ãƒ—ãƒ©ãƒ³ä½œæˆ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp plan -out=tfplan.azure

# ãƒ—ãƒ©ãƒ³å†…å®¹ç¢ºèª
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp show tfplan.azure > docs/plan-azure.txt

# é©ç”¨ï¼ˆç¢ºèªå¾Œï¼‰
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp apply tfplan.azure
```bash
#### ã‚¹ãƒ†ãƒƒãƒ—3: AWSç’°å¢ƒ Plan/Apply

```bash
# åˆæœŸåŒ–
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp init

# ãƒ—ãƒ©ãƒ³ä½œæˆ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp plan -out=tfplan.aws

# ãƒ—ãƒ©ãƒ³å†…å®¹ç¢ºèª
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp show tfplan.aws > docs/plan-aws.txt

# é©ç”¨ï¼ˆç¢ºèªå¾Œï¼‰
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp apply tfplan.aws
```bash
### Phase2 å®Ÿè¡Œçµæžœ

#### ðŸ” å®Ÿè¡Œãƒ­ã‚° (2025-08-17 03:34:22Z)

**Azureç’°å¢ƒãƒ†ã‚¹ãƒˆ:**

```bash
# âœ… InitæˆåŠŸ
docker run --rm -v "${PWD}:/workspace" -w /workspace hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp init
# Output: Terraform has been successfully initialized!

# âŒ Planå¤±æ•— - èªè¨¼æƒ…å ±ãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp plan
# Error: Specified tenant identifier 'your-tenant-id' is neither a valid DNS name
# Reason: .envãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿéš›ã®å€¤ã§ã¯ãªããƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
```bash
**ç¾åœ¨ã®.envçŠ¶æ³:**

- ARM_CLIENT_ID=your-client-id (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)
- ARM_CLIENT_SECRET=your-client-secret (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)
- ARM_SUBSCRIPTION_ID=your-subscription-id (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)
- ARM_TENANT_ID=your-tenant-id (ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)

**AWSç’°å¢ƒãƒ†ã‚¹ãƒˆ:**

```bash
# åŒæ§˜ã«èªè¨¼æƒ…å ±ãŒå¿…è¦ãªçŠ¶æ³
```bash
#### ðŸ“‹ ç¾åœ¨ã®çŠ¶æ³

- âœ… Terraformæ§‹æ–‡ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ : æ­£å¸¸
- âœ… åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹: æˆåŠŸ
- âŒ èªè¨¼æƒ…å ±: æœªè¨­å®šï¼ˆå®Ÿéš›ã®å€¤ãŒå¿…è¦ï¼‰
- âŒ Plan/Apply: èªè¨¼æƒ…å ±è¨­å®šå¾Œã«å®Ÿè¡Œå¯èƒ½

#### ðŸ” èªè¨¼æƒ…å ±è¨­å®šæ‰‹é †

**ç¾åœ¨ã®çŠ¶æ³:** .envãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®å€¤ã«æ›´æ–°ãŒå¿…è¦ã§ã™ã€‚

1. **Azure Service Principalä½œæˆ:**

```bash
# Azure CLIã§ãƒ­ã‚°ã‚¤ãƒ³
az login

# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDç¢ºèª
az account show --query id -o tsv

# Service Principalä½œæˆ
az ad sp create-for-rbac --name "terraform-sp" --role="Contributor" --scopes="/subscriptions/YOUR_SUBSCRIPTION_ID"

# å‡ºåŠ›ä¾‹:
# {
#   "appId": "12345678-1234-1234-1234-123456789012",        # â†’ ARM_CLIENT_ID
#   "displayName": "terraform-sp",
#   "password": "abcdef12-3456-7890-abcd-ef1234567890",     # â†’ ARM_CLIENT_SECRET
#   "tenant": "87654321-4321-4321-4321-210987654321"       # â†’ ARM_TENANT_ID
# }

# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDå–å¾—
az account show --query id -o tsv                          # â†’ ARM_SUBSCRIPTION_ID
```bash
1. **AWS IAM User/Roleè¨­å®š:**

```bash
aws configure
# ã¾ãŸã¯
export AWS_ACCESS_KEY_ID=your-key
export AWS_SECRET_ACCESS_KEY=your-secret
```bash
1. **.envæ›´æ–°æ‰‹é †:**

```bash
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®š
# ä¾‹:
ARM_CLIENT_ID=12345678-1234-1234-1234-123456789012
ARM_CLIENT_SECRET=abcdef12-3456-7890-abcd-ef1234567890
ARM_SUBSCRIPTION_ID=your-actual-subscription-id
ARM_TENANT_ID=87654321-4321-4321-4321-210987654321

AWS_ACCESS_KEY_ID=AKIA...
AWS_SECRET_ACCESS_KEY=your-actual-secret-key
```bash
1. **èªè¨¼ç¢ºèªã¨å®Ÿè¡Œ:**

```bash
# èªè¨¼ãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env mcr.microsoft.com/azure-cli az account show
docker run --rm --env-file .env amazon/aws-cli sts get-caller-identity

# Terraformå®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp plan

# ã¾ãŸã¯ Makefileã‚’ä½¿ç”¨
make docker-plan CLOUD=azure
make docker-apply CLOUD=azure
```bash
### ðŸ”„ ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆç§»è¡Œæº–å‚™

èªè¨¼æƒ…å ±è¨­å®šã¨ãƒ­ãƒ¼ã‚«ãƒ«applyæˆåŠŸå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆã«ç§»è¡Œå¯èƒ½ï¼š

#### Azureç§»è¡Œæ‰‹é †

```bash
# 1. Storage Accountä½œæˆ
az group create --name tfstate-rg --location "Japan East"
az storage account create --name tfstatesa --resource-group tfstate-rg --location "Japan East" --sku Standard_LRS

# 2. backend.hclæ›´æ–°
# resource_group_name  = "tfstate-rg"
# storage_account_name = "tfstatesa"
# container_name       = "tfstate"
# key                  = "azure-b1s-mvp.tfstate"

# 3. main.tfã®backendæœ‰åŠ¹åŒ–
# terraform { backend "azurerm" {} }

# 4. ç§»è¡Œå®Ÿè¡Œ
terraform -chdir=envs/azure/azure-b1s-mvp init -migrate-state -backend-config=backend.hcl
```bash
#### AWSç§»è¡Œæ‰‹é †

```bash
# 1. S3 + DynamoDBä½œæˆ
aws s3 mb s3://your-tfstate-bucket
aws dynamodb create-table --table-name terraform-locks --attribute-definitions AttributeName=LockID,AttributeType=S --key-schema AttributeName=LockID,KeyType=HASH --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5

# 2. backend.hclæ›´æ–°
# bucket         = "your-tfstate-bucket"
# key            = "aws-ec2-mvp.tfstate"
# region         = "ap-northeast-1"
# dynamodb_table = "terraform-locks"

# 3. main.tfã®backendæœ‰åŠ¹åŒ–
# terraform { backend "s3" {} }

# 4. ç§»è¡Œå®Ÿè¡Œ
terraform -chdir=envs/aws/aws-ec2-mvp init -migrate-state -backend-config=backend.hcl
```bash
### ðŸ’° ã‚³ã‚¹ãƒˆæ³¨æ„äº‹é …

**AzureæŽ¨å®šã‚³ã‚¹ãƒˆ:**

- Resource Group: ç„¡æ–™
- Virtual Network: ç„¡æ–™
- å°†æ¥ã®VM: Standard_B1s ~$10-15/æœˆ

**AWSæŽ¨å®šã‚³ã‚¹ãƒˆ:**

- VPC: ç„¡æ–™
- Subnet: ç„¡æ–™
- å°†æ¥ã®EC2: t3.micro ~$8-12/æœˆ

### ðŸ”™ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
make docker-destroy CLOUD=azure
make docker-destroy CLOUD=aws

# ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆå‰Šé™¤
rm -rf envs/azure/azure-b1s-mvp/.terraform/
rm -rf envs/aws/aws-ec2-mvp/.terraform/
rm -f envs/azure/azure-b1s-mvp/terraform.tfstate*
rm -f envs/aws/aws-ec2-mvp/terraform.tfstate*
```bash
## ðŸŽ¯ Phase1 å®Œäº† - æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

**Phase1é”æˆé …ç›®:**

- [x] Pre-commitè¨­å®šæœ€é©åŒ–ï¼ˆã‚³ã‚¢ã‚³ãƒ¼ãƒ‰ã®ã¿å¯¾è±¡ï¼‰
- [x] æ”¹è¡Œã‚³ãƒ¼ãƒ‰çµ±ä¸€ï¼ˆLFå›ºå®šï¼‰
- [x] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šæº–å‚™ï¼ˆæœªæœ‰åŠ¹åŒ–ï¼‰
- [x] Makefileã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¤œè¨¼å®Œäº†
- [x] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™

**Phase2æº–å‚™å®Œäº†:**

- ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨­å®šã‚µãƒ³ãƒ—ãƒ«æº–å‚™æ¸ˆã¿
- èªè¨¼æƒ…å ±ãƒã‚§ãƒƒã‚¯æ‰‹é †æ–‡æ›¸åŒ–æ¸ˆã¿
- Plan/Applyæ®µéšŽã¸ã®ç§»è¡Œæº–å‚™å®Œäº†

**æŽ¨å¥¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**

```bash
git commit -m "feat: complete Phase1 validation hardening

- Optimize pre-commit config (core code only, exclude MVP envs)
- Normalize line endings (LF) via .gitattributes & .editorconfig
- Prepare backend configs (commented, ready for Phase2)
- Verify Makefile targets: fmt, validate azure/aws
- Add comprehensive documentation in docs/kiro-setup.md

Phase1: âœ… All validation targets passing
Ready for Phase2: Remote state backend setup"
```bash
---

## ðŸ”„ Phase2 å®Ÿè¡ŒçŠ¶æ³ (æœ€æ–°)

### ç¾åœ¨ã®çŠ¶æ³

- âœ… Terraformæ§‹é€ : æ­£å¸¸
- âœ… åˆæœŸåŒ–: æˆåŠŸ
- âŒ èªè¨¼æƒ…å ±: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ã®ã¾ã¾
- â³ Plan/Apply: å®Ÿéš›ã®èªè¨¼æƒ…å ±è¨­å®šå¾…ã¡

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

1. Azure Service Principalã‚’ä½œæˆ
1. .envãƒ•ã‚¡ã‚¤ãƒ«ã«å®Ÿéš›ã®å€¤ã‚’è¨­å®š
1. èªè¨¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
1. Plan/Applyå®Ÿè¡Œ

### å®Ÿè¡Œæº–å‚™å®Œäº†ã‚³ãƒžãƒ³ãƒ‰

```bash
# èªè¨¼æƒ…å ±è¨­å®šå¾Œã€ä»¥ä¸‹ã‚’å®Ÿè¡Œ:

# Azure Plan
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp plan -out=tfplan.azure

# Azure Planè¡¨ç¤º
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp show tfplan.azure > docs/plan-azure.txt

# Azure Apply
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp apply tfplan.azure
```bash
## ðŸ” èªè¨¼æƒ…å ±è¨­å®šãŒå¿…è¦

ç¾åœ¨ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿéš›ã®èªè¨¼æƒ…å ±ã‚’å–å¾—ãƒ»è¨­å®šã—ã¦ãã ã•ã„ï¼š

### Azure Service Principalä½œæˆ

```bash
# 1. Azure CLIã§ãƒ­ã‚°ã‚¤ãƒ³
az login

# 2. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª
az account list --output table
az account set --subscription "your-subscription-name"

# 3. Service Principalä½œæˆ
az ad sp create-for-rbac --name "terraform-sp" --role="Contributor" \
  --scopes="/subscriptions/$(az account show --query id -o tsv)"

# å‡ºåŠ›ä¾‹ï¼ˆã“ã‚Œã‚‰ã®å€¤ã‚’.envã«è¨­å®šï¼‰:
# {
#   "appId": "12345678-abcd-1234-abcd-123456789012",     # ARM_CLIENT_ID
#   "password": "your-generated-secret",                 # ARM_CLIENT_SECRET
#   "tenant": "87654321-1234-1234-1234-210987654321"    # ARM_TENANT_ID
# }

# ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³IDå–å¾—
az account show --query id -o tsv                       # ARM_SUBSCRIPTION_ID
```bash
### AWSèªè¨¼æƒ…å ±å–å¾—

```bash
# 1. AWS CLIã§ãƒ­ã‚°ã‚¤ãƒ³
aws configure

# 2. èªè¨¼æƒ…å ±ç¢ºèª
aws sts get-caller-identity

# 3. Access Keyä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
aws iam create-access-key --user-name your-username
```bash
### .envæ›´æ–°å¾Œã®å®Ÿè¡Œ

èªè¨¼æƒ…å ±ã‚’å®Ÿéš›ã®å€¤ã«æ›´æ–°å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§Phase2ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
# ã‚¹ãƒ†ãƒƒãƒ—1: Azureèªè¨¼ãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env mcr.microsoft.com/azure-cli \
  sh -c 'az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID'

docker run --rm --env-file .env mcr.microsoft.com/azure-cli az account show

# ã‚¹ãƒ†ãƒƒãƒ—2: AWSèªè¨¼ãƒ†ã‚¹ãƒˆ
docker run --rm --env-file .env amazon/aws-cli sts get-caller-identity

# ã‚¹ãƒ†ãƒƒãƒ—3: Azure Terraformå®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp init

docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp plan -out=tfplan.azure

docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp show tfplan.azure > docs/plan-azure.txt

# ã‚¹ãƒ†ãƒƒãƒ—4: Azure Applyï¼ˆç¢ºèªå¾Œï¼‰
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp apply tfplan.azure

# ã‚¹ãƒ†ãƒƒãƒ—5: AWS Terraformå®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp init

docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp plan -out=tfplan.aws

docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp show tfplan.aws > docs/plan-aws.txt

# ã‚¹ãƒ†ãƒƒãƒ—6: AWS Applyï¼ˆç¢ºèªå¾Œï¼‰
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp apply tfplan.aws
```bash
---

## ðŸš€ Phase2: Azure One-Click App Deploy

### æ¦‚è¦

Azure Storage Static Websiteã‚’ä½¿ç”¨ã—ãŸæœ€å°ã‚³ã‚¹ãƒˆã®é™çš„ã‚µã‚¤ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ã€‚

### æ–°æ©Ÿèƒ½

- **é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**: `modules/static-website/azure`
- **ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤**: Makefileã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ 
- **è‡ªå‹•ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤**: Azure CLIçµ±åˆ

### å®Ÿè¡Œæ‰‹é †

#### 1. ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰

```bash
# Azureèªè¨¼æƒ…å ±ã‚’.envã«è¨­å®šå¾Œ
make up-azure
```bash
#### 2. ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤

```bash
make app-deploy
```bash
#### 3. URLç¢ºèª

```bash
make url-azure
```bash
#### 4. ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤

```bash
make down-azure
```bash
### ðŸ’° ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

- **Azure Storage (Static Website)**: ~Â¥1-5/æœˆ
- **ãƒ‡ãƒ¼ã‚¿è»¢é€**: æœ€åˆã®5GBç„¡æ–™ã€ãã®å¾Œ ~Â¥10/GB
- **åˆè¨ˆ**: é€šå¸¸ ~Â¥10-50/æœˆ (å°è¦æ¨¡ã‚µã‚¤ãƒˆ)

### ðŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# Terraformã§ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
make down-azure

# æ‰‹å‹•å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
az group delete --name sre-iac-starter-rg --yes --no-wait
```bash
### ðŸ“ ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«

- `modules/static-website/azure/` - é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
- `app/index.html` - ã‚µãƒ³ãƒ—ãƒ«Webãƒšãƒ¼ã‚¸
- `Makefile` - ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ 

### ðŸ”§ ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆæº–å‚™ (Phase3)

```bash
# backend.hclè¨­å®šä¾‹
resource_group_name  = "tfstate-rg"
storage_account_name = "tfstatesa"
container_name       = "tfstate"
key                  = "azure-b1s-mvp.tfstate"

# main.tfã§backendæœ‰åŠ¹åŒ–
terraform { backend "azurerm" {} }

# ç§»è¡Œå®Ÿè¡Œ
terraform init -migrate-state -backend-config=backend.hcl
```bash
---

## âœ… Phase2 å®Ÿè¡Œçµæžœ (2025-08-17 16:40)

### ðŸŽ‰ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ

**Azure Static Website URL:**
```bash
https://sreiacdevm627ymaf.z11.web.core.windows.net/
```bash
**Storage Account Name:**
```bash
sreiacdevm627ymaf
```bash
### å®Ÿè¡Œãƒ­ã‚°

#### 1. ã‚¨ãƒ©ãƒ¼ä¿®æ­£

```bash
# å•é¡Œ: Storage AccountåãŒ24æ–‡å­—åˆ¶é™ã‚’è¶…éŽ
# ä¿®æ­£: åå‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã‚’æ”¹å–„
# çµæžœ: sreiacdevm627ymaf (17æ–‡å­—) âœ…
```bash
#### 2. ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰

```bash
make up-azure
# âœ… åˆæœŸåŒ–æˆåŠŸ
# âœ… ãƒ—ãƒ©ãƒ³æˆåŠŸ (3ãƒªã‚½ãƒ¼ã‚¹è¿½åŠ )
# âœ… é©ç”¨æˆåŠŸ (1åˆ†11ç§’ã§å®Œäº†)
```bash
#### 3. ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹

- âœ… `random_string.suffix`: m627ymaf
- âœ… `azurerm_storage_account.static_site`: sreiacdevm627ymaf
- âœ… `azurerm_storage_account_network_rules.static_site`: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ«ãƒ¼ãƒ«

#### 4. å‡ºåŠ›å€¤
```bash
static_website_url = "https://sreiacdevm627ymaf.z11.web.core.windows.net/"
storage_account_name = "sreiacdevm627ymaf"
subnet_id = "/subscriptions/.../subnets/app"
```bash
### ðŸ’° å®Ÿéš›ã®ã‚³ã‚¹ãƒˆ

- **Azure Storage Account**: Standard_LRS, Hot tier
- **æŽ¨å®šæœˆé¡**: ~Â¥5-50 (ä½¿ç”¨é‡ã«ã‚ˆã‚‹)
- **é™çš„ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæ©Ÿèƒ½**: ç„¡æ–™

### ðŸ”§ ä¿®æ­£å†…å®¹

1. **Storage Accountåå‰åˆ¶ç´„å¯¾å¿œ**
   - 24æ–‡å­—åˆ¶é™ã«å¯¾å¿œ
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåçŸ­ç¸®: `sre-iac-starter` â†’ `sreiac`
   - å®‰å…¨ãªåå‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 

1. **locals ãƒ–ãƒ­ãƒƒã‚¯è¿½åŠ **
   - åå‰ç”Ÿæˆã®å¯èª­æ€§å‘ä¸Š
   - Azureåˆ¶ç´„ã®æ˜Žç¤ºçš„å¯¾å¿œ

### ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤**: `make app-deploy`
1. **URLç¢ºèª**: `make url-azure`
1. **ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤**: `make down-azure`

èªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¦ã„ãŸã ã‘ã‚Œã°ã€ã™ãã«Phase2ã‚’å®Œäº†ã§ãã¾ã™ï¼---

## ðŸ”„ Phase3: ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆç§»è¡Œæ‰‹é †ï¼ˆå®Ÿè¡Œå‰ç¢ºèªï¼‰

**æ³¨æ„: ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã¯Phase2æˆåŠŸå¾Œã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚ç¾åœ¨ã¯å®Ÿè¡Œã—ãªã„ã§ãã ã•ã„ã€‚**

### Azure Storage Backendç§»è¡Œ

```bash
# 1. Azure Storage Accountä½œæˆ
az group create --name tfstate-rg --location "Japan East"
az storage account create \
  --name tfstatesa \
  --resource-group tfstate-rg \
  --location "Japan East" \
  --sku Standard_LRS \
  --encryption-services blob

# 2. Storage Containerä½œæˆ
az storage container create \
  --name tfstate \
  --account-name tfstatesa

# 3. backend.hclæ›´æ–°
cat > envs/azure/azure-b1s-mvp/backend.hcl << EOF
resource_group_name  = "tfstate-rg"
storage_account_name = "tfstatesa"
container_name       = "tfstate"
key                  = "azure-b1s-mvp.tfstate"
EOF

# 4. main.tfã®backendæœ‰åŠ¹åŒ–
# terraform { backend "azurerm" {} } ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤

# 5. ç§»è¡Œå®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp \
  init -migrate-state -backend-config=backend.hcl
```bash
### AWS S3 Backendç§»è¡Œ

```bash
# 1. S3ãƒã‚±ãƒƒãƒˆä½œæˆ
aws s3 mb s3://your-unique-tfstate-bucket-name

# 2. DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
aws dynamodb create-table \
  --table-name terraform-locks \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5

# 3. backend.hclæ›´æ–°
cat > envs/aws/aws-ec2-mvp/backend.hcl << EOF
bucket         = "your-unique-tfstate-bucket-name"
key            = "aws-ec2-mvp.tfstate"
region         = "ap-northeast-1"
dynamodb_table = "terraform-locks"
encrypt        = true
EOF

# 4. main.tfã®backendæœ‰åŠ¹åŒ–
# terraform { backend "s3" {} } ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’è§£é™¤

# 5. ç§»è¡Œå®Ÿè¡Œ
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp \
  init -migrate-state -backend-config=backend.hcl
```bash
### ðŸ’° ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

**Azure (æœˆé¡):**

- Resource Group: ç„¡æ–™
- Virtual Network: ç„¡æ–™
- Storage Account: ~$0.05/æœˆ
- å°†æ¥ã®VM (Standard_B1s): ~$10-15/æœˆ

**AWS (æœˆé¡):**

- VPC: ç„¡æ–™
- Subnet: ç„¡æ–™
- S3 (tfstate): ~$0.01/æœˆ
- DynamoDB (locks): ~$1.25/æœˆ
- å°†æ¥ã®EC2 (t3.micro): ~$8-12/æœˆ

### ðŸ”™ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

```bash
# ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/azure/azure-b1s-mvp destroy

docker run --rm -v "${PWD}:/workspace" -w /workspace --env-file .env \
  hashicorp/terraform:1.9.5 -chdir=envs/aws/aws-ec2-mvp destroy

# ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒ†ãƒ¼ãƒˆå‰Šé™¤
rm -rf envs/azure/azure-b1s-mvp/.terraform/
rm -rf envs/aws/aws-ec2-mvp/.terraform/
rm -f envs/azure/azure-b1s-mvp/terraform.tfstate*
rm -f envs/aws/aws-ec2-mvp/terraform.tfstate*

# ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆå‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
az storage container delete --name tfstate --account-name tfstatesa
aws s3 rb s3://your-unique-tfstate-bucket-name --force
aws dynamodb delete-table --table-name terraform-locks
```bash
