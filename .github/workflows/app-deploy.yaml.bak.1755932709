name: app-deploy
on:
  push:
    branches: [main]
    paths:
      - "app/**"
      - "app-landing/**"

permissions:
  contents: read

env:
  TFSTATE_RG: sre-iac-starter-tfstate-rg
  TFSTATE_LOC: japaneast
  TFSTATE_CONTAINER: tfstate
  TFSTATE_KEY: azure-b1s-mvp.tfstate

jobs:
  deploy-static-site:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }

      - name: Ensure tfstate backend resources
        env:
          TFSTATE_RG: ${{ env.TFSTATE_RG }}
          TFSTATE_LOC: ${{ env.TFSTATE_LOC }}
          TFSTATE_CONTAINER: ${{ env.TFSTATE_CONTAINER }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        run: |
          bash scripts/ci/ensure-tfstate.sh | tee ensure.log
          SA=$(grep '^TFSTATE_SA=' ensure.log | cut -d= -f2)
          echo "TFSTATE_SA=$SA" >> $GITHUB_ENV

      - name: Terraform Init (remote backend / read state)
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          terraform -chdir=envs/azure/azure-b1s-mvp init \
            -backend-config="resource_group_name=${{ env.TFSTATE_RG }}" \
            -backend-config="storage_account_name=${{ env.TFSTATE_SA }}" \
            -backend-config="container_name=${{ env.TFSTATE_CONTAINER }}" \
            -backend-config="key=${{ env.TFSTATE_KEY }}"

      - name: Resolve outputs (robust)
        id: out
        env:
          TF_DIR: envs/azure/azure-b1s-mvp
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          set -euo pipefail
<<<<<<< HEAD

          TFDIR="envs/azure/azure-b1s-mvp"

          # 1) まず -raw で直接取得（stderr を捨てる）。失敗しても続行。
          SA_NAME="$(terraform -chdir="$TFDIR" output -raw storage_account_name 2>/dev/null || true)"
          WEB_URL="$(terraform -chdir="$TFDIR" output -raw static_website_url 2>/dev/null || true)"

          # 2) もし上が空なら -json を使って安全にパース（python を使用：GH runner にあり）
          if [ -z "$SA_NAME" ] || [ -z "$WEB_URL" ]; then
            # terraform output -json で JSON を取得（stderr を捨てる）
            OUT_JSON="$(terraform -chdir="$TFDIR" output -json 2>/dev/null || echo '{}')"

            if [ -z "$SA_NAME" ]; then
              SA_NAME="$(echo "$OUT_JSON" | python -c "import sys,json; j=json.load(sys.stdin); print(j.get('storage_account_name',{}).get('value',''))" 2>/dev/null || true)"
            fi

            if [ -z "$WEB_URL" ]; then
              WEB_URL="$(echo "$OUT_JSON" | python -c "import sys,json; j=json.load(sys.stdin); print(j.get('static_website_url',{}).get('value',''))" 2>/dev/null || true)"
            fi
          fi

          # 3) 安全化：先頭行だけ取り、改行やCRを除去
          SA_NAME="$(printf '%s' "$SA_NAME" | tr -d '\r' | head -n1 || true)"
          WEB_URL="$(printf '%s' "$WEB_URL" | tr -d '\r' | head -n1 || true)"

          # 4) 出力（必ず「name=value」の形式で書く）
          echo "sa_name=$SA_NAME" >> $GITHUB_OUTPUT
          echo "web_url=$WEB_URL" >> $GITHUB_OUTPUT

          # debug logs (optional) — comment out in production if noisy
          echo ">> debug: sa_name='$SA_NAME'"
          echo ">> debug: web_url='$WEB_URL'"


      - name: Upload to $web
=======

          echo "Checking Terraform state and outputs..."

          # Terraformのstateを確認
          if ! terraform -chdir="$TF_DIR" state list >/dev/null 2>&1; then
            echo "No Terraform state found."
            echo "sa_name=" >> "$GITHUB_OUTPUT"
            echo "web_url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # outputを安全に取得
          if terraform -chdir="$TF_DIR" output -json >/dev/null 2>&1; then
            echo "Terraform outputs found, processing..."

            # Storage Account名を取得
            SA_NAME=$(terraform -chdir="$TF_DIR" output \
              -raw storage_account_name 2>/dev/null || echo "")
            WEB_URL=$(terraform -chdir="$TF_DIR" output \
              -raw static_website_url 2>/dev/null || echo "")

            echo "sa_name=$SA_NAME" >> "$GITHUB_OUTPUT"
            echo "web_url=$WEB_URL" >> "$GITHUB_OUTPUT"
            echo "Outputs set: sa_name=$SA_NAME, web_url=$WEB_URL"
          else
            echo "No outputs available, using fallback method..."
            RG_NAME="sre-iac-starter-rg"

            SA_NAME=$(az storage account list --resource-group "$RG_NAME" \
              --query "[?contains(name, 'sreiac')].name | [0]" \
              -o tsv 2>/dev/null || echo "")

            if [ -n "$SA_NAME" ]; then
              WEB_URL=$(az storage account show -n "$SA_NAME" \
                -g "$RG_NAME" --query "primaryEndpoints.web" \
                -o tsv 2>/dev/null || echo "")
              echo "Found storage account via Azure CLI: $SA_NAME"
            else
              echo "No storage account found, using empty values"
              WEB_URL=""
            fi

            echo "sa_name=$SA_NAME" >> "$GITHUB_OUTPUT"
            echo "web_url=$WEB_URL" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload to Static Website
>>>>>>> e184bc0 (ci: fix YAML EOF newline and relax yamllint for workflows)
        env:
          SA_NAME: ${{ steps.out.outputs.sa_name }}
          WEB_URL: ${{ steps.out.outputs.web_url }}
        run: |
          if [ -z "$SA_NAME" ]; then
            echo "No storage account name available."
            echo "Please run the terraform-apply workflow first."
            exit 1
          fi

          echo "Uploading to storage account: $SA_NAME"

          # ソースディレクトリを決定
          SRC_DIR=""
          for d in "app-landing" "app/dist" "app"; do
            if [ -d "$d" ]; then
              SRC_DIR="$d"
              echo "Using source directory: $SRC_DIR"
              break
            fi
          done

          if [ -z "$SRC_DIR" ]; then
            SRC_DIR="app"
            echo "Creating default directory: $SRC_DIR"
            mkdir -p "$SRC_DIR"
          fi

          # デフォルトのindex.htmlを作成（存在しない場合）
          if [ ! -f "$SRC_DIR/index.html" ]; then
            echo "Creating default index.html"
            printf '%s\n' \
              '<!doctype html>' \
              '<html lang="ja">' \
              '<head>' \
              '  <meta charset="utf-8">' \
              '  <title>SRE IaC Starter</title>' \
              '  <meta name="viewport" content="width=device-width, initial-scale=1.0">' \
              '</head>' \
              '<body>' \
              '  <h1>SRE IaC Starter</h1>' \
              "  <p>Deployed: $(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>" \
              "  <p>Storage Account: \$SA_NAME</p>" \
              '</body>' \
              '</html>' \
              > "$SRC_DIR/index.html"
          fi
<<<<<<< HEAD
          az storage blob upload-batch --account-name "$SA_NAME" -s "$SRC_DIR" -d '$web' --overwrite --auth-mode login
          echo "${{ steps.out.outputs.web_url }}"

=======

          # ファイルをアップロード
          echo "Uploading files to web container..."
          if az storage blob upload-batch \
            --account-name "$SA_NAME" \
            --source "$SRC_DIR" \
            --destination '$web' \
            --overwrite \
            --auth-mode login; then
            echo "Upload successful!"
            if [ -n "$WEB_URL" ]; then
              echo "Website URL: $WEB_URL"
            else
              echo "Website should be available at: https://$SA_NAME.z11.web.core.windows.net/"
            fi
          else
            echo "Upload failed!"
            exit 1
          fi
>>>>>>> e184bc0 (ci: fix YAML EOF newline and relax yamllint for workflows)
